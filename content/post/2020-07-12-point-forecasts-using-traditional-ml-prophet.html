---
title: A template for comparing point forecasts using traditional models, Prophet, and supervised machine learning
author: Danny Morris
date: '2020-07-12'
output: 
  blogdown::html_page:
    toc: true
    highlight: pygments
slug: time-series-forecasting-as-a-supervised-machine-learning-problem
categories:
  - R
  - Machine Learning
  - Forecasting
tags:
  - R
  - Machine Learning
  - Forecasting
editor_options: 
  chunk_output_type: console
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/jquery/jquery.min.js"></script>
<link href="/rmarkdown-libs/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/datatables-binding/datatables.js"></script>
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="/rmarkdown-libs/dt-core/js/jquery.dataTables.min.js"></script>
<link href="/rmarkdown-libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/crosstalk/js/crosstalk.min.js"></script>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<div id="TOC">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#models">Models</a></li>
<li><a href="#r-packages">R packages</a></li>
<li><a href="#data">Data</a></li>
<li><a href="#prepare-models-and-encapsulate-as-functions">Prepare models and encapsulate as functions</a><ul>
<li><a href="#traditional-models">Traditional models</a></li>
<li><a href="#machine-learning-models">Machine learning models</a></li>
<li><a href="#prophet-model">Prophet model</a></li>
<li><a href="#ensemble-model">Ensemble model</a></li>
</ul></li>
<li><a href="#configure-rolling-origin-cross-validation-with-varying-horizons">Configure rolling origin cross validation with varying horizons</a></li>
<li><a href="#run-cross-validation">Run cross validation</a></li>
<li><a href="#model-performance">Model performance</a><ul>
<li><a href="#best-model-for-each-horizon-range">Best model for each horizon range</a></li>
<li><a href="#visualize-performance-across-all-horizon-ranges">Visualize performance across all horizon ranges</a></li>
</ul></li>
<li><a href="#customizing-this-template">Customizing this template</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>

<div id="overview" class="section level2">
<h2>Overview</h2>
<p>This post presents a customizable template with R code for comparing point forecast accuracy using different categories of forecasting models and varying horizon ranges (short-, moderate-, and long-term). The application shown here is monthly health insurance claims forecasting, although this template generalizes to any forecasting application with some application-specific modifications. In this post, 8 models are compared over 4 different horizon ranges incuding 1, 3, 6, and 11 months. The models include traditional, machine learning, and Facebook Prophet algorithms. For each model in the comparison, performance is measured by calculating the mean and standard deviation of RMSE for each horizon range using rolling origin cross validation. For example, for an Arima model the average and standard deviation of RMSE is calculated for horizon ranges of 1, 3, 6, and 11 months after cross validation. Models with small average errors and small error variance are considered good quality models.</p>
<p>This is a powerful methodology that emphasizes model diversity and empirical scientific experimentation. In a large scale forecasting application this methodology can easily be parallelized for increases in speed and scale since it uses the <a href="https://www.jstatsoft.org/article/view/v040i01/v40i01.pdf">split-apply-combine</a> computing technique. Furthermore, with additional modifications this template can be used for fully automatic model selection in a production environment whereby the best models for each horizon range are automatically deployed based on performance rankings.</p>
</div>
<div id="models" class="section level2">
<h2>Models</h2>
<p>The models used in this template include:</p>
<ul>
<li>Traditional (Seasonal naive, Arima, ETS, Autoregressive neural network)</li>
<li>Supervised machine learning (Random Forest, GLM, MLP neural network)</li>
<li>Facebook Prophet</li>
<li>Ensemble (averaging) of traditional, ML, and Prophet models</li>
</ul>
<p>The list of models can be expanded to include any type of forecasting model that produces point forecasts. Ideas include STL decomposition and LSTM neural networks.</p>
</div>
<div id="r-packages" class="section level2">
<h2>R packages</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># Data wrangling and visualization</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">library</span>(plotly)</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">library</span>(DT)</a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co"># ML helper packages</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">library</span>(rsample)</a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">library</span>(yardstick)</a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw">library</span>(recipes)</a>
<a class="sourceLine" id="cb1-11" title="11"></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="co"># Forecasting and ML frameworks</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw">library</span>(forecast)</a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">library</span>(h2o)</a>
<a class="sourceLine" id="cb1-15" title="15"><span class="kw">library</span>(prophet)</a></code></pre></div>
</div>
<div id="data" class="section level2">
<h2>Data</h2>
<p>The data used in this example contains monthly health insurance claims with calendar and population adjustments already applied. The target variable is <em>Adj_PMPM</em>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">sample_df &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;https://abn-distro.s3.amazonaws.com/sample_pmpm.csv&quot;</span>) </a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3">sample_df</a></code></pre></div>
<pre><code>## # A tibble: 48 x 5
##    Inc_Month  Adj_PMPM Total_Claims Population Effective_Days_Index
##    &lt;date&gt;        &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;                &lt;dbl&gt;
##  1 2016-01-01     1.68      143031.     88072.                0.969
##  2 2016-02-01     1.68      143095.     88002.                0.966
##  3 2016-03-01     1.69      155876.     87893.                1.05 
##  4 2016-04-01     1.72      146057.     87894.                0.967
##  5 2016-05-01     1.66      147634.     87689                 1.01 
##  6 2016-06-01     1.69      148985.     87653                 1.01 
##  7 2016-07-01     1.59      134767.     87239.                0.973
##  8 2016-08-01     1.65      152131.     87182.                1.06 
##  9 2016-09-01     1.65      144339.     87302.                1.00 
## 10 2016-10-01     1.75      149476.     87341.                0.979
## # ... with 38 more rows</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">sample_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Inc_Month, <span class="dt">y =</span> Adj_PMPM)) <span class="op">+</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.05</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Monthly insurance claims with calendar and population adjustments&quot;</span>,</a>
<a class="sourceLine" id="cb4-6" title="6">       <span class="dt">x =</span> <span class="st">&quot;Month&quot;</span>,</a>
<a class="sourceLine" id="cb4-7" title="7">       <span class="dt">y =</span> <span class="st">&quot;Adjusted PMPM&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="st">  </span><span class="kw">theme_bw</span>()</a></code></pre></div>
<p><img src="/post/2020-07-12-point-forecasts-using-traditional-ml-prophet_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
</div>
<div id="prepare-models-and-encapsulate-as-functions" class="section level2">
<h2>Prepare models and encapsulate as functions</h2>
<p>I highly recommend encapsulating models as functions for a few reasons:</p>
<ol style="list-style-type: decimal">
<li><p>Each model is completely isolated from the rest and can be configured and tuned individually.</p></li>
<li><p>Adding new models to the comparison is a simple matter of writing a new function and plugging it in.</p></li>
<li><p>Each model can be configured to produce a standardized output. In this application, the standardized output is a vector of point forecasts.</p></li>
</ol>
<div id="traditional-models" class="section level3">
<h3>Traditional models</h3>
<p>Traditional models use lagged values of the target variable to produce forecasts. The traditional models used in this example include:</p>
<ul>
<li>Seasonal naive</li>
<li>Arima (automatic parameter tuning)</li>
<li>Exponential smoothing state space (automatic parameter tuning)</li>
<li>Feed-forward autoregressive neural network</li>
</ul>
<p>These models are built using the well-known <a href="https://otexts.com/fpp2/">forecast package</a>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">help</span>(snaive)</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">help</span>(auto.arima)</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">help</span>(ets)</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="kw">help</span>(nnetar)</a></code></pre></div>
<div id="functions" class="section level4">
<h4>Functions</h4>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co">##################</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co"># Seasonal naive #</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">##################</span></a>
<a class="sourceLine" id="cb6-4" title="4">snaive_model &lt;-<span class="st"> </span><span class="cf">function</span>(y, h) {</a>
<a class="sourceLine" id="cb6-5" title="5">  <span class="kw">snaive</span>(y, <span class="dt">h =</span> h)<span class="op">$</span>mean <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.vector</span>()</a>
<a class="sourceLine" id="cb6-6" title="6">}</a>
<a class="sourceLine" id="cb6-7" title="7"></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">#########</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="co"># Arima #</span></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co">#########</span></a>
<a class="sourceLine" id="cb6-11" title="11">arima_model &lt;-<span class="st"> </span><span class="cf">function</span>(y, h) {</a>
<a class="sourceLine" id="cb6-12" title="12">  fit &lt;-<span class="st"> </span><span class="kw">auto.arima</span>(y)</a>
<a class="sourceLine" id="cb6-13" title="13">  fcast &lt;-<span class="st"> </span><span class="kw">forecast</span>(fit, <span class="dt">h =</span> h)<span class="op">$</span>mean <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.vector</span>()</a>
<a class="sourceLine" id="cb6-14" title="14">  <span class="kw">return</span>(fcast)</a>
<a class="sourceLine" id="cb6-15" title="15">}</a>
<a class="sourceLine" id="cb6-16" title="16"></a>
<a class="sourceLine" id="cb6-17" title="17"><span class="co">#######</span></a>
<a class="sourceLine" id="cb6-18" title="18"><span class="co"># ETS #</span></a>
<a class="sourceLine" id="cb6-19" title="19"><span class="co">#######</span></a>
<a class="sourceLine" id="cb6-20" title="20">ets_model &lt;-<span class="st"> </span><span class="cf">function</span>(y, h) {</a>
<a class="sourceLine" id="cb6-21" title="21">  fit &lt;-<span class="st"> </span><span class="kw">ets</span>(y)</a>
<a class="sourceLine" id="cb6-22" title="22">  fcast &lt;-<span class="st"> </span><span class="kw">forecast</span>(fit, <span class="dt">h =</span> h)<span class="op">$</span>mean <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.vector</span>()</a>
<a class="sourceLine" id="cb6-23" title="23">  <span class="kw">return</span>(fcast)</a>
<a class="sourceLine" id="cb6-24" title="24">}</a>
<a class="sourceLine" id="cb6-25" title="25"></a>
<a class="sourceLine" id="cb6-26" title="26"><span class="co">#################</span></a>
<a class="sourceLine" id="cb6-27" title="27"><span class="co"># AR neural net #</span></a>
<a class="sourceLine" id="cb6-28" title="28"><span class="co">#################</span></a>
<a class="sourceLine" id="cb6-29" title="29">nnetar_model &lt;-<span class="st"> </span><span class="cf">function</span>(y, h) {</a>
<a class="sourceLine" id="cb6-30" title="30">  fit &lt;-<span class="st"> </span><span class="kw">nnetar</span>(y)</a>
<a class="sourceLine" id="cb6-31" title="31">  fcast &lt;-<span class="st"> </span><span class="kw">forecast</span>(fit, <span class="dt">h =</span> h)<span class="op">$</span>mean <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.vector</span>()</a>
<a class="sourceLine" id="cb6-32" title="32">  <span class="kw">return</span>(fcast)</a>
<a class="sourceLine" id="cb6-33" title="33">}</a></code></pre></div>
</div>
</div>
<div id="machine-learning-models" class="section level3">
<h3>Machine learning models</h3>
<p>The machine learning models use explicit engineered features to predict future values of the target variable. In this application, features include:</p>
<ul>
<li>one-hot-encoded month</li>
<li>one-hot encoded year</li>
<li>Target variable lagged by 12 months</li>
</ul>
<p>The one-hot encoded date-based features can be engineered in advance since these features are static (i.e. known in advance). The 12-month target lag cannot be engineered in advance since this feature is dependent on the specific cross validation iteration.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">date_features &lt;-<span class="st"> </span>sample_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="st">  </span><span class="kw">select</span>(Inc_Month) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Month =</span> lubridate<span class="op">::</span><span class="kw">month</span>(Inc_Month)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Year =</span> lubridate<span class="op">::</span><span class="kw">year</span>(Inc_Month)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="op">-</span>Inc_Month), <span class="kw">list</span>(as.factor)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="st">  </span>recipes<span class="op">::</span><span class="kw">recipe</span>(<span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> .) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="st">  </span>recipes<span class="op">::</span><span class="kw">step_dummy</span>(<span class="kw">all_predictors</span>(), <span class="op">-</span>Inc_Month, <span class="dt">one_hot =</span> T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="st">  </span>recipes<span class="op">::</span><span class="kw">prep</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-9" title="9"><span class="st">  </span>recipes<span class="op">::</span><span class="kw">juice</span>()</a></code></pre></div>
<p>The models include:</p>
<ul>
<li>Random forest</li>
<li>Generalized linear model</li>
<li>Feed-forward MLP neural network</li>
</ul>
<p>These models are built using the <a href="https://www.h2o.ai/wp-content/uploads/2018/01/RBooklet.pdf">H2O framework</a>, which is my preferred machine learning framework.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">help</span>(h2o.randomForest)</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">help</span>(h2o.glm)</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="kw">help</span>(h2o.deeplearning)</a></code></pre></div>
<div id="functions-1" class="section level4">
<h4>Functions</h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="co"># function to return vector of predictions from H2O fitted models.</span></a>
<a class="sourceLine" id="cb9-2" title="2">predict_h2o &lt;-<span class="st"> </span><span class="cf">function</span>(m, test_df) {</a>
<a class="sourceLine" id="cb9-3" title="3">  test_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="st">    </span><span class="kw">drop_na</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="st">    </span><span class="kw">as.h2o</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="st">    </span><span class="kw">predict</span>(m, <span class="dt">newdata =</span> .) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="st">    </span><span class="kw">as.vector</span>()</a>
<a class="sourceLine" id="cb9-8" title="8">}</a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="co"># Note that all models use default H2O parameters for simplicity</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="co"># Hyperparameter tuning may lead to increased accuracy</span></a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="co">#################</span></a>
<a class="sourceLine" id="cb10-5" title="5"><span class="co"># Random Forest #</span></a>
<a class="sourceLine" id="cb10-6" title="6"><span class="co">#################</span></a>
<a class="sourceLine" id="cb10-7" title="7">rf_model &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, train_df, test_df) {</a>
<a class="sourceLine" id="cb10-8" title="8">  fit &lt;-<span class="st"> </span><span class="kw">h2o.randomForest</span>(<span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb10-9" title="9">                          <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb10-10" title="10">                          <span class="dt">training_frame =</span> <span class="kw">as.h2o</span>(train_df))</a>
<a class="sourceLine" id="cb10-11" title="11">  fcast &lt;-<span class="st"> </span><span class="kw">predict_h2o</span>(fit, <span class="dt">test_df =</span> test_df)</a>
<a class="sourceLine" id="cb10-12" title="12">  <span class="kw">return</span>(fcast)</a>
<a class="sourceLine" id="cb10-13" title="13">}</a>
<a class="sourceLine" id="cb10-14" title="14"></a>
<a class="sourceLine" id="cb10-15" title="15"><span class="co">############################</span></a>
<a class="sourceLine" id="cb10-16" title="16"><span class="co"># Generalized linear model #</span></a>
<a class="sourceLine" id="cb10-17" title="17"><span class="co">############################</span></a>
<a class="sourceLine" id="cb10-18" title="18">glm_model &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, train_df, test_df) {</a>
<a class="sourceLine" id="cb10-19" title="19">  fit &lt;-<span class="st"> </span><span class="kw">h2o.glm</span>(<span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb10-20" title="20">                 <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb10-21" title="21">                 <span class="dt">training_frame =</span> <span class="kw">as.h2o</span>(train_df))</a>
<a class="sourceLine" id="cb10-22" title="22">  fcast &lt;-<span class="st"> </span><span class="kw">predict_h2o</span>(fit, <span class="dt">test_df =</span> test_df)</a>
<a class="sourceLine" id="cb10-23" title="23">  <span class="kw">return</span>(fcast)</a>
<a class="sourceLine" id="cb10-24" title="24">}</a>
<a class="sourceLine" id="cb10-25" title="25"></a>
<a class="sourceLine" id="cb10-26" title="26"><span class="co">##################</span></a>
<a class="sourceLine" id="cb10-27" title="27"><span class="co"># MLP neural net #</span></a>
<a class="sourceLine" id="cb10-28" title="28"><span class="co">##################</span></a>
<a class="sourceLine" id="cb10-29" title="29">mlp_model &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, train_df, test_df) {</a>
<a class="sourceLine" id="cb10-30" title="30">  fit &lt;-<span class="st"> </span><span class="kw">h2o.deeplearning</span>(<span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb10-31" title="31">                          <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb10-32" title="32">                          <span class="dt">training_frame =</span> <span class="kw">as.h2o</span>(train_df))</a>
<a class="sourceLine" id="cb10-33" title="33">  fcast &lt;-<span class="st"> </span><span class="kw">predict_h2o</span>(fit, <span class="dt">test_df =</span> test_df)</a>
<a class="sourceLine" id="cb10-34" title="34">  <span class="kw">return</span>(fcast)</a>
<a class="sourceLine" id="cb10-35" title="35">}</a></code></pre></div>
</div>
</div>
<div id="prophet-model" class="section level3">
<h3>Prophet model</h3>
<p>Developed by Facebook’s Core Data Science team, <a href="https://facebook.github.io/prophet/">Prophet</a> is a robust decomposition model designed for “business time series”, which often exhibit multiple seasonalities and outliers. It accepts a variety of time series data (e.g. monthly, data, sub-daily) and it accepts extra regressors. It is relatively fast, robust to outliers and trend changes, and it requires very little coding to get started.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">help</span>(prophet)</a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">prophet_model &lt;-<span class="st"> </span><span class="cf">function</span>(train_df, test_df) {</a>
<a class="sourceLine" id="cb12-2" title="2">  fit &lt;-<span class="st"> </span>prophet<span class="op">::</span><span class="kw">prophet</span>(<span class="dt">df =</span> train_df,</a>
<a class="sourceLine" id="cb12-3" title="3">                          <span class="dt">growth =</span> <span class="st">&quot;linear&quot;</span>,</a>
<a class="sourceLine" id="cb12-4" title="4">                          <span class="dt">yearly.seasonality =</span> T,</a>
<a class="sourceLine" id="cb12-5" title="5">                          <span class="dt">weekly.seasonality =</span> F,</a>
<a class="sourceLine" id="cb12-6" title="6">                          <span class="dt">daily.seasonality =</span> F)</a>
<a class="sourceLine" id="cb12-7" title="7">  fcast &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">df =</span> test_df) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(yhat)</a>
<a class="sourceLine" id="cb12-8" title="8">  <span class="kw">return</span>(fcast)</a>
<a class="sourceLine" id="cb12-9" title="9">}</a></code></pre></div>
</div>
<div id="ensemble-model" class="section level3">
<h3>Ensemble model</h3>
<p>The ensemble model is a simple average of the previously defined models. A dedicated function is not necessary.</p>
</div>
</div>
<div id="configure-rolling-origin-cross-validation-with-varying-horizons" class="section level2">
<h2>Configure rolling origin cross validation with varying horizons</h2>
<p>The rolling origin cross validation strategy is defined as follows:</p>
<ul>
<li>Intital training split uses years 2016-2018, initial test split uses 2019 only</li>
<li>Horizon ranges of 1, 3, 6, and 11 for a total of 31 resamples</li>
<li>Cumulative training data as origin shifts forward</li>
<li>12 months of lag values of the target variable included in test set to enable feature engineering</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">horizons &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">11</span>)</a>
<a class="sourceLine" id="cb13-2" title="2"></a>
<a class="sourceLine" id="cb13-3" title="3">cv_splits &lt;-<span class="st"> </span><span class="kw">map</span>(horizons, <span class="cf">function</span>(i) {</a>
<a class="sourceLine" id="cb13-4" title="4">  rsample<span class="op">::</span><span class="kw">rolling_origin</span>(</a>
<a class="sourceLine" id="cb13-5" title="5">    <span class="dt">data =</span> sample_df,</a>
<a class="sourceLine" id="cb13-6" title="6">    <span class="dt">initial =</span> <span class="dv">36</span>,</a>
<a class="sourceLine" id="cb13-7" title="7">    <span class="dt">assess =</span> i,</a>
<a class="sourceLine" id="cb13-8" title="8">    <span class="dt">cumulative =</span> T,</a>
<a class="sourceLine" id="cb13-9" title="9">    <span class="dt">lag =</span> <span class="dv">12</span></a>
<a class="sourceLine" id="cb13-10" title="10">  ) </a>
<a class="sourceLine" id="cb13-11" title="11">}) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-12" title="12"><span class="st">  </span><span class="kw">bind_rows</span>()</a>
<a class="sourceLine" id="cb13-13" title="13"></a>
<a class="sourceLine" id="cb13-14" title="14">cv_splits</a></code></pre></div>
<pre><code>## # A tibble: 31 x 2
##    splits          id     
##    &lt;list&gt;          &lt;chr&gt;  
##  1 &lt;split [36/13]&gt; Slice01
##  2 &lt;split [37/13]&gt; Slice02
##  3 &lt;split [38/13]&gt; Slice03
##  4 &lt;split [39/13]&gt; Slice04
##  5 &lt;split [40/13]&gt; Slice05
##  6 &lt;split [41/13]&gt; Slice06
##  7 &lt;split [42/13]&gt; Slice07
##  8 &lt;split [43/13]&gt; Slice08
##  9 &lt;split [44/13]&gt; Slice09
## 10 &lt;split [45/13]&gt; Slice10
## # ... with 21 more rows</code></pre>
</div>
<div id="run-cross-validation" class="section level2">
<h2>Run cross validation</h2>
<p>This anonymous function does the following <em>within each cross validtion fold</em>:</p>
<ul>
<li>Separate the train and test sets for the current CV iteration</li>
<li>Produce forecasts with traditional models</li>
<li>Produce forecasts with ML models</li>
<li>Produce forecasts with Prophet model</li>
<li>Produce an ensemble forecast by combining traditional, ML, and Prophet models</li>
<li>Backtransform forecasts to original units</li>
<li>Report mean and standard deviation of RMSE</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="co"># Inititalize H2O cluster</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="kw">h2o.init</span>()</a></code></pre></div>
<pre><code>##  Connection successful!
## 
## R is connected to the H2O cluster: 
##     H2O cluster uptime:         1 hours 39 minutes 
##     H2O cluster timezone:       America/New_York 
##     H2O data parsing timezone:  UTC 
##     H2O cluster version:        3.30.0.1 
##     H2O cluster version age:    3 months and 12 days !!! 
##     H2O cluster name:           H2O_started_from_R_Owner_wqt072 
##     H2O cluster total nodes:    1 
##     H2O cluster total memory:   3.36 GB 
##     H2O cluster total cores:    4 
##     H2O cluster allowed cores:  4 
##     H2O cluster healthy:        TRUE 
##     H2O Connection ip:          localhost 
##     H2O Connection port:        54321 
##     H2O Connection proxy:       NA 
##     H2O Internal Security:      FALSE 
##     H2O API Extensions:         Amazon S3, Algos, AutoML, Core V3, TargetEncoder, Core V4 
##     R Version:                  R version 3.6.1 (2019-07-05)</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">h2o.no_progress</span>()</a></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">model_comp &lt;-<span class="st"> </span><span class="kw">map</span>(cv_splits<span class="op">$</span>splits, <span class="cf">function</span>(cv) {</a>
<a class="sourceLine" id="cb18-2" title="2">  </a>
<a class="sourceLine" id="cb18-3" title="3">  <span class="co">#########################</span></a>
<a class="sourceLine" id="cb18-4" title="4">  <span class="co">## CV train/test split ##</span></a>
<a class="sourceLine" id="cb18-5" title="5">  <span class="co">#########################</span></a>
<a class="sourceLine" id="cb18-6" title="6">  </a>
<a class="sourceLine" id="cb18-7" title="7">  <span class="co"># train</span></a>
<a class="sourceLine" id="cb18-8" title="8">  train &lt;-<span class="st"> </span><span class="kw">analysis</span>(cv) </a>
<a class="sourceLine" id="cb18-9" title="9">  </a>
<a class="sourceLine" id="cb18-10" title="10">  <span class="co"># test is the true testing set, but test_w_lags is used</span></a>
<a class="sourceLine" id="cb18-11" title="11">  <span class="co"># for engineering features</span></a>
<a class="sourceLine" id="cb18-12" title="12">  test &lt;-<span class="st"> </span><span class="kw">assessment</span>(cv) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="kw">seq</span>(<span class="dv">13</span>, <span class="kw">nrow</span>(.), <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb18-13" title="13">  test_w_lags &lt;-<span class="st"> </span><span class="kw">assessment</span>(cv)</a>
<a class="sourceLine" id="cb18-14" title="14">  </a>
<a class="sourceLine" id="cb18-15" title="15">  <span class="co">########################</span></a>
<a class="sourceLine" id="cb18-16" title="16">  <span class="co">## Traditional models ##</span></a>
<a class="sourceLine" id="cb18-17" title="17">  <span class="co">########################</span></a>
<a class="sourceLine" id="cb18-18" title="18">  </a>
<a class="sourceLine" id="cb18-19" title="19">  <span class="co"># target variable as ts object required by forecast package</span></a>
<a class="sourceLine" id="cb18-20" title="20">  y &lt;-<span class="st"> </span><span class="kw">ts</span>(train<span class="op">$</span>Adj_PMPM, <span class="dt">start =</span> <span class="dv">2016</span>, <span class="dt">freq =</span> <span class="dv">12</span>)</a>
<a class="sourceLine" id="cb18-21" title="21">  <span class="co"># horizon range</span></a>
<a class="sourceLine" id="cb18-22" title="22">  h &lt;-<span class="st"> </span><span class="kw">nrow</span>(test)</a>
<a class="sourceLine" id="cb18-23" title="23">  </a>
<a class="sourceLine" id="cb18-24" title="24">  <span class="co"># Seasonal naive</span></a>
<a class="sourceLine" id="cb18-25" title="25">  snaive_fcast &lt;-<span class="st"> </span><span class="kw">snaive_model</span>(y, h)</a>
<a class="sourceLine" id="cb18-26" title="26">  <span class="co"># Arima</span></a>
<a class="sourceLine" id="cb18-27" title="27">  arima_fcast &lt;-<span class="st"> </span><span class="kw">arima_model</span>(y, h)</a>
<a class="sourceLine" id="cb18-28" title="28">  <span class="co"># ETS</span></a>
<a class="sourceLine" id="cb18-29" title="29">  ets_fcast &lt;-<span class="st"> </span><span class="kw">ets_model</span>(y, h)</a>
<a class="sourceLine" id="cb18-30" title="30">  <span class="co"># NNETAR</span></a>
<a class="sourceLine" id="cb18-31" title="31">  nnetar_fcast &lt;-<span class="st"> </span><span class="kw">nnetar_model</span>(y, h)</a>
<a class="sourceLine" id="cb18-32" title="32">  </a>
<a class="sourceLine" id="cb18-33" title="33">  <span class="co">#############################</span></a>
<a class="sourceLine" id="cb18-34" title="34">  <span class="co">## Machine learning models ##</span></a>
<a class="sourceLine" id="cb18-35" title="35">  <span class="co">#############################</span></a>
<a class="sourceLine" id="cb18-36" title="36">  </a>
<a class="sourceLine" id="cb18-37" title="37">  <span class="co"># function for engineering features</span></a>
<a class="sourceLine" id="cb18-38" title="38">  engineer_features &lt;-<span class="st"> </span><span class="cf">function</span>(df) {</a>
<a class="sourceLine" id="cb18-39" title="39">    df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-40" title="40"><span class="st">      </span><span class="kw">inner_join</span>(date_features, <span class="dt">by =</span> <span class="st">&quot;Inc_Month&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-41" title="41"><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">Adj_PMPM_Lag_12 =</span> <span class="kw">lag</span>(Adj_PMPM, <span class="dv">12</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-42" title="42"><span class="st">      </span><span class="kw">select</span>(Adj_PMPM,</a>
<a class="sourceLine" id="cb18-43" title="43">             Adj_PMPM_Lag_<span class="dv">12</span>,</a>
<a class="sourceLine" id="cb18-44" title="44">             <span class="kw">contains</span>(<span class="st">&quot;Month_&quot;</span>),</a>
<a class="sourceLine" id="cb18-45" title="45">             <span class="kw">contains</span>(<span class="st">&quot;Year_&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-46" title="46"><span class="st">      </span><span class="kw">drop_na</span>()</a>
<a class="sourceLine" id="cb18-47" title="47">  }</a>
<a class="sourceLine" id="cb18-48" title="48">  </a>
<a class="sourceLine" id="cb18-49" title="49">  <span class="co"># train/test splits for ML models</span></a>
<a class="sourceLine" id="cb18-50" title="50">  ml_train &lt;-<span class="st"> </span>train <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">engineer_features</span>()</a>
<a class="sourceLine" id="cb18-51" title="51">  ml_test &lt;-<span class="st"> </span>test_w_lags <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">engineer_features</span>()</a>
<a class="sourceLine" id="cb18-52" title="52">  </a>
<a class="sourceLine" id="cb18-53" title="53">  <span class="co"># Feature/target names as strings required by H2O</span></a>
<a class="sourceLine" id="cb18-54" title="54">  X =<span class="st"> </span>ml_train <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>Adj_PMPM) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">colnames</span>()</a>
<a class="sourceLine" id="cb18-55" title="55">  y =<span class="st"> &quot;Adj_PMPM&quot;</span></a>
<a class="sourceLine" id="cb18-56" title="56">  </a>
<a class="sourceLine" id="cb18-57" title="57">  <span class="co"># Random forest</span></a>
<a class="sourceLine" id="cb18-58" title="58">  rf_fcast &lt;-<span class="st"> </span><span class="kw">rf_model</span>(X, y, ml_train, ml_test)</a>
<a class="sourceLine" id="cb18-59" title="59">  <span class="co"># GLM</span></a>
<a class="sourceLine" id="cb18-60" title="60">  glm_fcast &lt;-<span class="st"> </span><span class="kw">glm_model</span>(X, y, ml_train, ml_test)</a>
<a class="sourceLine" id="cb18-61" title="61">  <span class="co"># MLP neural net</span></a>
<a class="sourceLine" id="cb18-62" title="62">  mlp_fcast &lt;-<span class="st"> </span><span class="kw">mlp_model</span>(X, y, ml_train, ml_test)</a>
<a class="sourceLine" id="cb18-63" title="63">  </a>
<a class="sourceLine" id="cb18-64" title="64">  <span class="co">############################</span></a>
<a class="sourceLine" id="cb18-65" title="65">  <span class="co">## Facebook Prophet model ##</span></a>
<a class="sourceLine" id="cb18-66" title="66">  <span class="co">############################</span></a>
<a class="sourceLine" id="cb18-67" title="67">  </a>
<a class="sourceLine" id="cb18-68" title="68">  <span class="co"># Train/test splits formatted per Prophet specs</span></a>
<a class="sourceLine" id="cb18-69" title="69">  prophet_train &lt;-<span class="st"> </span>train <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">ds =</span> Inc_Month, <span class="dt">y =</span> Adj_PMPM)</a>
<a class="sourceLine" id="cb18-70" title="70">  prophet_test &lt;-<span class="st"> </span>test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">ds =</span> Inc_Month, <span class="dt">y =</span> Adj_PMPM)</a>
<a class="sourceLine" id="cb18-71" title="71">  </a>
<a class="sourceLine" id="cb18-72" title="72">  <span class="co"># Prophet</span></a>
<a class="sourceLine" id="cb18-73" title="73">  prophet_fcast &lt;-<span class="st"> </span><span class="kw">prophet_model</span>(<span class="dt">train_df =</span> prophet_train, </a>
<a class="sourceLine" id="cb18-74" title="74">                                 <span class="dt">test_df =</span> prophet_test)</a>
<a class="sourceLine" id="cb18-75" title="75">  </a>
<a class="sourceLine" id="cb18-76" title="76">  <span class="co">####################</span></a>
<a class="sourceLine" id="cb18-77" title="77">  <span class="co">## Ensemble model ##</span></a>
<a class="sourceLine" id="cb18-78" title="78">  <span class="co">####################</span></a>
<a class="sourceLine" id="cb18-79" title="79">  </a>
<a class="sourceLine" id="cb18-80" title="80">  model_list &lt;-<span class="st"> </span><span class="kw">list</span>(snaive_fcast, </a>
<a class="sourceLine" id="cb18-81" title="81">                     arima_fcast, </a>
<a class="sourceLine" id="cb18-82" title="82">                     ets_fcast, </a>
<a class="sourceLine" id="cb18-83" title="83">                     nnetar_fcast,</a>
<a class="sourceLine" id="cb18-84" title="84">                     rf_fcast, </a>
<a class="sourceLine" id="cb18-85" title="85">                     glm_fcast, </a>
<a class="sourceLine" id="cb18-86" title="86">                     mlp_fcast,</a>
<a class="sourceLine" id="cb18-87" title="87">                     prophet_fcast)</a>
<a class="sourceLine" id="cb18-88" title="88">  </a>
<a class="sourceLine" id="cb18-89" title="89">  ensemble_fcast &lt;-<span class="st"> </span>model_list <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-90" title="90"><span class="st">    </span><span class="kw">reduce</span>(<span class="st">`</span><span class="dt">+</span><span class="st">`</span>)<span class="op">/</span><span class="kw">length</span>(model_list)</a>
<a class="sourceLine" id="cb18-91" title="91">  </a>
<a class="sourceLine" id="cb18-92" title="92">  <span class="co">##################</span></a>
<a class="sourceLine" id="cb18-93" title="93">  <span class="co">## Measure RMSE ##</span></a>
<a class="sourceLine" id="cb18-94" title="94">  <span class="co">##################</span></a>
<a class="sourceLine" id="cb18-95" title="95">  </a>
<a class="sourceLine" id="cb18-96" title="96">  <span class="co"># function to transform forecasts to original units and calc RMSE</span></a>
<a class="sourceLine" id="cb18-97" title="97">  backtransform_forecasts &lt;-<span class="st"> </span><span class="cf">function</span>(fcast) {</a>
<a class="sourceLine" id="cb18-98" title="98">    backtransform &lt;-<span class="st"> </span>fcast<span class="op">*</span>test<span class="op">$</span>Population<span class="op">*</span>test<span class="op">$</span>Effective_Days_Index</a>
<a class="sourceLine" id="cb18-99" title="99">    actual &lt;-<span class="st"> </span>test<span class="op">$</span>Total_Claims</a>
<a class="sourceLine" id="cb18-100" title="100">    yardstick<span class="op">::</span><span class="kw">rmse_vec</span>(actual, backtransform)</a>
<a class="sourceLine" id="cb18-101" title="101">  }</a>
<a class="sourceLine" id="cb18-102" title="102">  </a>
<a class="sourceLine" id="cb18-103" title="103">  <span class="co"># apply RMSE calculation to each model</span></a>
<a class="sourceLine" id="cb18-104" title="104">  rmse_tbl &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb18-105" title="105">    <span class="dt">snaive =</span> snaive_fcast,</a>
<a class="sourceLine" id="cb18-106" title="106">    <span class="dt">arima =</span> arima_fcast,</a>
<a class="sourceLine" id="cb18-107" title="107">    <span class="dt">ets =</span> ets_fcast,</a>
<a class="sourceLine" id="cb18-108" title="108">    <span class="dt">nnetar =</span> nnetar_fcast,</a>
<a class="sourceLine" id="cb18-109" title="109">    <span class="dt">h2o_rf =</span> rf_fcast,</a>
<a class="sourceLine" id="cb18-110" title="110">    <span class="dt">h2o_glm =</span> glm_fcast,</a>
<a class="sourceLine" id="cb18-111" title="111">    <span class="dt">h2o_mlp =</span> mlp_fcast,</a>
<a class="sourceLine" id="cb18-112" title="112">    <span class="dt">prophet =</span> prophet_fcast,</a>
<a class="sourceLine" id="cb18-113" title="113">    <span class="dt">ensemble =</span> ensemble_fcast</a>
<a class="sourceLine" id="cb18-114" title="114">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-115" title="115"><span class="st">    </span><span class="kw">map</span>(backtransform_forecasts) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-116" title="116"><span class="st">    </span><span class="kw">bind_cols</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-117" title="117"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">horizon =</span> <span class="kw">nrow</span>(test))</a>
<a class="sourceLine" id="cb18-118" title="118">  </a>
<a class="sourceLine" id="cb18-119" title="119">  <span class="kw">return</span>(rmse_tbl)</a>
<a class="sourceLine" id="cb18-120" title="120">})</a></code></pre></div>
</div>
<div id="model-performance" class="section level2">
<h2>Model performance</h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">model_performance &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(model_comp) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-2" title="2"><span class="st">  </span><span class="kw">gather</span>(model, rmse, <span class="op">-</span>horizon) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(model, horizon) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb19-5" title="5">    <span class="dt">mean_rmse =</span> <span class="kw">mean</span>(rmse),</a>
<a class="sourceLine" id="cb19-6" title="6">    <span class="dt">sd_rmse =</span> <span class="kw">sd</span>(rmse)</a>
<a class="sourceLine" id="cb19-7" title="7">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-8" title="8"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="st">  </span><span class="kw">arrange</span>(horizon)</a>
<a class="sourceLine" id="cb19-10" title="10"></a>
<a class="sourceLine" id="cb19-11" title="11">DT<span class="op">::</span><span class="kw">datatable</span>(model_performance, <span class="dt">rownames =</span> F) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="st">  </span>DT<span class="op">::</span><span class="kw">formatRound</span>(<span class="dt">columns =</span> <span class="kw">c</span>(<span class="st">&quot;mean_rmse&quot;</span>, <span class="st">&quot;sd_rmse&quot;</span>), <span class="dt">digits =</span> <span class="dv">0</span>)</a></code></pre></div>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["arima","ensemble","ets","h2o_glm","h2o_mlp","h2o_rf","nnetar","prophet","snaive","arima","ensemble","ets","h2o_glm","h2o_mlp","h2o_rf","nnetar","prophet","snaive","arima","ensemble","ets","h2o_glm","h2o_mlp","h2o_rf","nnetar","prophet","snaive","arima","ensemble","ets","h2o_glm","h2o_mlp","h2o_rf","nnetar","prophet","snaive"],[1,1,1,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3,6,6,6,6,6,6,6,6,6,11,11,11,11,11,11,11,11,11],[2960.86095273783,2223.81901742723,2397.58411414185,2477.20887379453,2989.48387320678,3047.90271749654,3146.80317300737,2899.39923430492,2472.3033177564,3289.60365780976,2587.79743873946,2773.0347166435,2794.47527052389,3927.77628090564,3467.15304173188,3222.61400153563,2866.02253263219,2970.33084470457,3648.88946792067,2670.38599611893,2964.07322434276,2828.51226369324,3797.19663519984,3557.11551815565,3169.01312584529,3053.09934898981,3055.08209681017,3802.75349060314,3220.87329590894,3574.811338721,3194.23941538471,6340.71136359951,3963.32153231957,3589.34384981833,3445.03200674861,3155.10336827668],[2053.81096714645,2068.8618566987,2235.12091337724,2055.92292043469,2110.76028768808,1930.82502212669,1492.7607611988,2391.19001568072,1925.84461890767,1542.3508122841,1695.09849605639,1516.88001897388,1641.36102021521,2707.29342742615,1513.40558784652,507.53761706777,1494.55559690648,1467.0106863635,1286.87745572942,1292.56569417147,1224.540853066,1355.13388961399,2671.13932335385,1230.09743224905,572.149034804184,745.660187921847,1048.79944840749,1744.0969571765,714.926075149155,353.666165944718,785.616121324006,269.299888487824,430.483557825821,620.218311769506,40.83725231143,31.4511561979539]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>model<\/th>\n      <th>horizon<\/th>\n      <th>mean_rmse<\/th>\n      <th>sd_rmse<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":[2,3],"render":"function(data, type, row, meta) { return DTWidget.formatRound(data, 0, 3, \",\", \".\"); }"},{"className":"dt-right","targets":[1,2,3]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render"],"jsHooks":[]}</script>
<div id="best-model-for-each-horizon-range" class="section level3">
<h3>Best model for each horizon range</h3>
<p>The “best model” definition is application-specific. In this application, the ideal model is one that minimizes error (accuracy) and minimizes error variance (stability). Both metrics are weighted equally in determining the best model for each horizon range. This is accomplished by assigning a ranking to each model for each metric, then averaging the two rankings to arrive at a final ranking.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">model_rankings &lt;-<span class="st"> </span>model_performance <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(horizon) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">mean_rmse_rank =</span> <span class="kw">min_rank</span>(mean_rmse)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sd_rmse_rank =</span> <span class="kw">min_rank</span>(sd_rmse)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">average_rank =</span> (mean_rmse_rank <span class="op">+</span><span class="st"> </span>sd_rmse_rank)<span class="op">/</span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">final_rank =</span> <span class="kw">min_rank</span>(average_rank)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-7" title="7"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb20-8" title="8"></a>
<a class="sourceLine" id="cb20-9" title="9">best_models &lt;-<span class="st"> </span>model_rankings <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-10" title="10"><span class="st">  </span><span class="kw">group_by</span>(horizon) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-11" title="11"><span class="st">  </span><span class="kw">filter</span>(final_rank <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(final_rank)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-12" title="12"><span class="st">  </span><span class="kw">select</span>(model, horizon, mean_rmse, sd_rmse, final_rank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-13" title="13"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb20-14" title="14"></a>
<a class="sourceLine" id="cb20-15" title="15">DT<span class="op">::</span><span class="kw">datatable</span>(best_models, <span class="dt">rownames =</span> F) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-16" title="16"><span class="st">  </span>DT<span class="op">::</span><span class="kw">formatRound</span>(<span class="dt">columns =</span> <span class="kw">c</span>(<span class="st">&quot;mean_rmse&quot;</span>, <span class="st">&quot;sd_rmse&quot;</span>), <span class="dt">digits =</span> <span class="dv">0</span>)</a></code></pre></div>
<div id="htmlwidget-2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"filter":"none","data":[["snaive","ets","nnetar","prophet","snaive","prophet","snaive"],[1,3,3,3,3,6,11],[2472.3033177564,2773.0347166435,3222.61400153563,2866.02253263219,2970.33084470457,3053.09934898981,3155.10336827668],[1925.84461890767,1516.88001897388,507.53761706777,1494.55559690648,1467.0106863635,745.660187921847,31.4511561979539],[1,1,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>model<\/th>\n      <th>horizon<\/th>\n      <th>mean_rmse<\/th>\n      <th>sd_rmse<\/th>\n      <th>final_rank<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":[2,3],"render":"function(data, type, row, meta) { return DTWidget.formatRound(data, 0, 3, \",\", \".\"); }"},{"className":"dt-right","targets":[1,2,3,4]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render"],"jsHooks":[]}</script>
</div>
<div id="visualize-performance-across-all-horizon-ranges" class="section level3">
<h3>Visualize performance across all horizon ranges</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">model_performance <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-2" title="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> mean_rmse, <span class="dt">y =</span> sd_rmse)) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>horizon, <span class="dt">ncol =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> model, <span class="dt">shape =</span> model), <span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> scales<span class="op">::</span><span class="kw">pretty_breaks</span>(<span class="dt">n =</span> <span class="dv">10</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="st">  </span><span class="kw">scale_shape_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="dv">11</span><span class="op">:</span><span class="dv">20</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Mean and standard deviation of RMSE by horizon range&quot;</span>,</a>
<a class="sourceLine" id="cb21-8" title="8">       <span class="dt">x =</span> <span class="st">&quot;Mean RMSE&quot;</span>,</a>
<a class="sourceLine" id="cb21-9" title="9">       <span class="dt">y =</span> <span class="st">&quot;SD RMSE&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-10" title="10"><span class="st">  </span><span class="kw">theme_bw</span>()</a></code></pre></div>
<p><img src="/post/2020-07-12-point-forecasts-using-traditional-ml-prophet_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>Some interesting takeaways:</p>
<ul>
<li><p>The seasonal naive model is generally the most accurate and stable model, ranking 1st or tied for 1st in the 1-, 3-, and 11- month horizon range and performing very well in the 6-month horizon range..</p></li>
<li><p>The ensemble model is very accurate though not quite as stable as other models.</p></li>
<li><p>Among the traditional models, exponential smoothing and seasonal naive models outperformed the Arima model by a large margin.</p></li>
<li><p>Among the ML models, the GLM model is the clear winner in all horizon ranges. Compared to the other model types, it did very well overall. The Random Forest and MLP models are neither accurate nor stable. Perhaps this is due to overfitting.</p></li>
<li><p>The Prophet model performed quite well in the 3-, 6-, and 11-month horizon ranges. However, it did poorly in the 1-month horizon range.</p></li>
</ul>
</div>
</div>
<div id="customizing-this-template" class="section level2">
<h2>Customizing this template</h2>
<p>This template generalizes to any forecasting application with a similar objective, but it will need to be adapted per application. Depending on the application, some customizations will be needed. Ideas include:</p>
<ul>
<li><p>Expand list of models</p></li>
<li><p>Modify cross validation strategy</p></li>
<li><p>Evaluate performance based on prediction intervals instead of point accuracy</p></li>
<li><p>Tune ML models using hyperparameter tuning</p></li>
<li><p>Detect and remove outliers</p></li>
<li><p>Engineer additional features</p></li>
</ul>
</div>
<div id="conclusion" class="section level2">
<h2>Conclusion</h2>
<p>This is a useful template for comparing different categories of forecast models with varying horizon ranges. This post compares traditional, machine learning, and Prophet models. The results show that, based on cross validated errors, some models perform better with short-term horizons than others, and vice versa.</p>
</div>
